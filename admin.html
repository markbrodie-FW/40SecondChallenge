<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Leaderboard — Admin (Cloud)</title>
  <style>
    :root{
      --bg:#0e0f12; --panel:#151822; --muted:#9aa3af; --text:#e5e7eb; --border:#1f2633; --good:#34d399; --bad:#ef4444; --cta:#22c55e;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,Noto Sans,sans-serif;background:var(--bg);color:var(--text)}
    .container{max-width:1200px;margin:0 auto;padding:20px}
    header{display:flex;align-items:center;gap:16px;justify-content:space-between;margin-bottom:16px}
    .sub{color:var(--muted)}

    .panel{background:var(--panel);border:1px solid var(--border);border-radius:16px;padding:16px}
    .stack{display:grid;gap:14px}
    label{display:block;font-size:13px;color:var(--muted);margin-bottom:6px}
    input[type="text"], input[type="number"], input[type="password"], input[type="email"], input[type="file"], textarea, select{
      width:100%;padding:18px 16px;border-radius:12px;border:1px solid var(--border);background:#0b0d13;color:var(--text);font-size:20px;
    }
    button{appearance:none;border:1px solid var(--border);background:#0b0d13;color:var(--text);padding:12px 16px;border-radius:12px;cursor:pointer;font-size:18px}
    button.primary{background:linear-gradient(180deg,#111726,#0e1522);border-color:#2a3345}
    button.ghost{background:transparent}
    button.danger{border-color:#3b1e24;background:#1a0f12;color:#fca5a5}
    .btn-cta{ background: var(--cta-bg) !important; color: var(--cta-text) !important; border-color: var(--cta-border) !important; font-weight:700 }

    /* Settings cog */
    .icon-btn{display:inline-flex;align-items:center;gap:8px;border:1px solid var(--border);background:#0b0d13;padding:10px 12px;border-radius:12px}
    .icon-btn svg{width:18px;height:18px}

    /* Two-column / three-row entry grid */
    .entry-grid{display:grid;grid-template-columns:1fr 1fr;gap:14px}
    .entry-grid > *{width:100%}
    .entry-type{display:flex;align-items:center;gap:16px;padding:14px;border:1px solid var(--border);border-radius:12px}
    .entry-type label{margin:0;color:var(--text);font-size:16px}
    #add, #clear-fields{width:100%;height:56px}

    @media (max-width:900px){
      .entry-grid{grid-template-columns:1fr}
    }

    .table-wrap{overflow:auto;border:1px solid var(--border);border-radius:16px}
    table{width:100%;border-collapse:separate;border-spacing:0}
    th,td{padding:12px 14px;border-bottom:1px solid var(--border)}
    th{position:sticky;top:0;background:#10131b;color:var(--muted);text-align:left;font-weight:600}
    tr:last-child td{border-bottom:none}
    .rank{font-variant-numeric:tabular-nums;font-weight:700}
    .time{font-variant-numeric:tabular-nums}

    /* Settings modal */
    .modal{position:fixed;inset:0;display:none;align-items:center;justify-content:center;z-index:50}
    .modal[open]{display:flex}
    .backdrop{position:absolute;inset:0;background:rgba(0,0,0,0.55);backdrop-filter:blur(2px)}
    .modal-card{position:relative;background:var(--panel);border:1px solid var(--border);border-radius:16px;padding:16px;max-width:560px;width:92vw}
    .modal-head{display:flex;align-items:center;justify-content:space-between;margin-bottom:8px}
      
    /* === Tablet tuning (portrait & landscape) === */
    :root{ --btn-h: clamp(52px, 7vmin, 64px); --field-fs: clamp(18px, 2.5vmin, 22px); }
    .container{ max-width:1100px; }
    input[type="text"], input[type="number"], input[type="password"], input[type="email"], input[type="file"], textarea, select{
      font-size: var(--field-fs);
    }
    .entry-grid{ grid-auto-rows: minmax(56px, auto); }
    #add, #clear-fields{ height: var(--btn-h); }
    table{ font-size: clamp(14px, 2vmin, 18px); }
    th,td{ padding: clamp(10px, 1.8vmin, 14px); }
    .entry-type input[type="radio"]{ transform: scale(1.25); }

    /* Portrait: single column, compact padding */
    @media (orientation: portrait){
      .container{ max-width: 720px; padding: 12px 16px; }
      .entry-grid{ grid-template-columns: 1fr; }
    }

    /* Landscape: always two columns (overrides smaller-width rule) */
    @media (orientation: landscape){
      .entry-grid{ grid-template-columns: 1fr 1fr !important; }
    }
  

    /* === Theme support (Light/Dark) === */
    :root{ --control-bg:#0b0d13; --control-text: var(--text); --thead:#10131b; }
    [data-theme="light"]{
      --bg:#ffffff; --panel:#ffffff; --text:#0b0d13; --muted:#4b5563; --border:#e5e7eb;
      --control-bg:#ffffff; --control-text:#0b0d13; --thead:#f3f4f6;
    }
    /* Override controls & headers with theme-aware vars */
    input[type="text"], input[type="number"], input[type="password"], input[type="email"], input[type="file"], textarea, select{
      background: var(--control-bg) !important; color: var(--control-text) !important; border-color: var(--border) !important;
    }
    button{ background: var(--control-bg) !important; color: var(--control-text) !important; border-color: var(--border) !important; }
    .icon-btn{ background: var(--control-bg) !important; color: var(--control-text) !important; }
    th{ background: var(--thead) !important; }
  

    /* CTA & Danger brand colours */
    :root{ --cta-bg:#22c55e; --cta-text:#052b12; --cta-border:#16a34a; --danger-bg:#ef4444; --danger-text:#ffffff; --danger-border:#dc2626; }
    .btn-cta{ background: var(--cta-bg) !important; color: var(--cta-text) !important; border-color: var(--cta-border) !important; font-weight:700 }
    .btn-danger{ background: var(--danger-bg) !important; color: var(--danger-text) !important; border-color: var(--danger-border) !important; font-weight:700 }
  

    /* Header rows + footer signout */
    .admin-header{ display:grid; gap:6px; margin-bottom:16px }
    .header-row1{ display:flex; align-items:center; justify-content:space-between }
    .header-row1 .title{ font-size:clamp(22px,3vw,36px); font-weight:800 }
    .header-row2{ display:flex; align-items:center; justify-content:space-between; gap:10px }
    .header-actions{ display:flex; gap:10px; align-items:center }
    .open-display{ color:inherit; opacity:.8; text-decoration:underline }
    .admin-footer{ max-width:1200px; margin:24px auto 12px; padding:6px 20px }
    .signout-link{ color:inherit; opacity:.8; text-decoration:underline }
  </style>
</head>
<body>
  <div class="container">
    <header class="admin-header">
      <div class="header-row1">
        <div class="title">Leaderboard Admin</div>
      </div>
      <div class="header-row2">
        <a href="index.html" class="open-display">Open Display</a>
        <div class="header-actions">
          <button id="btn-settings" class="icon-btn" title="Display settings">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true"><path d="M12 15.5a3.5 3.5 0 1 0 0-7 3.5 3.5 0 0 0 0 7Z"/><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 1 1-2.83 2.83l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 1 1-4 0v-.09a1.65 1.65 0 0 0-1-1.51 1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 1 1-2.83-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 1 1 0-4h.09a1.65 1.65 0 0 0 1.51-1 1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 1 1 2.83-2.83l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 1 1 4 0v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 1 1 2.83 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9c0 .66.39 1.26 1 1.51.32.14.67.21 1.02.21H21a2 2 0 1 1 0 4h-.09a1.65 1.65 0 0 0-1.51 1Z"/></svg>
            Settings
          </button>
          <button id="btn-theme" class="icon-btn" title="Toggle light/dark">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true"><circle cx="12" cy="12" r="5"/><path d="M12 1v2M12 21v2M4.22 4.22l1.42 1.42M18.36 18.36l1.42 1.42M1 12h2M21 12h2M4.22 19.78l1.42-1.42M18.36 5.64l1.42-1.42"/></svg>
            <span class="theme-label">Dark</span>
          </button>
        </div>
      </div>
    </header>

    <!-- Auth Panel -->
    <div class="panel" id="login-panel">
      <div style="font-weight:700;margin-bottom:8px">Sign in</div>
      <div class="stack">
        <div>
          <label>Email</label>
          <input id="email" type="email" placeholder="you@example.com" />
        </div>
        <div>
          <label>Password</label>
          <input id="password" type="password" placeholder="••••••••" />
        </div>
      </div>
      <div style="display:flex;gap:10px;align-items:center;margin-top:10px">
        <button class="primary" id="btn-login">Sign in</button>
        <div class="sub">Create this user in Firebase Console → Authentication.</div>
      </div>
      <div id="login-msg" class="sub" style="margin-top:8px"></div>
    </div>

    <!-- Admin UI (hidden until authed) -->
    <div id="app" hidden>
      <div class="panel">
        <div class="entry-grid">
          <!-- Row 1 -->
          <div>
            <label>First name</label>
            <input id="first" type="text" placeholder="Jane" />
          </div>
          <div>
            <label>Last name</label>
            <input id="last" type="text" placeholder="Smith" />
          </div>

          <!-- Row 2 -->
          <div>
            <label>Time (accepts mm:ss.mmm, ss.mmm, or seconds)</label>
            <input id="time" type="text" placeholder="1:12.345 or 72.345 or 72" />
          </div>
          <div class="entry-type">
            <label style="display:flex;gap:6px;align-items:center"><input type="radio" name="entrantType" value="adult" checked> Adult</label>
            <label style="display:flex;gap:6px;align-items:center"><input type="radio" name="entrantType" value="child"> Child</label>
          </div>

          <!-- Row 3 -->
          <button class="btn-cta" id="add">Add Entry</button>
          <button class="btn-danger" id="clear-fields">Clear Fields</button>
        </div>
      </div>

      <div class="panel">
        <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:8px">
          <div style="font-weight:700">Entries (auto-sorted by quickest time)</div>
        </div>
        <div class="table-wrap">
          <table aria-label="Entries table">
            <thead>
              <tr>
                <th style="width:80px">#</th>
                <th>Name</th>
                <th style="width:160px">Time</th>
                <th style="width:120px">Actions</th>
              </tr>
            </thead>
            <tbody id="admin-tbody"></tbody>
          </table>
        </div>
      </div>
    </div>
  </div>

  <!-- Settings Modal -->
  <div id="settings-modal" class="modal" aria-hidden="true" role="dialog" aria-modal="true">
    <div class="backdrop" data-close></div>
    <div class="modal-card" role="document">
      <div class="modal-head">
        <div style="font-weight:700">Display Settings</div>
        <button class="ghost" id="btn-close-settings" title="Close">✕</button>
      </div>
      <div class="stack">
        <div>
          <label>Screen title</label>
          <input id="setting-title" type="text" placeholder="Leaderboard title" />
        </div>
        <div>
          <label>Show top N (blank = all)</label>
          <input id="setting-topN" type="number" min="1" />
        </div>
        <div>
          <label>Rotate highlight every (seconds, 0 = off)</label>
          <input id="setting-rotate" type="number" min="0" value="0" />
        </div>
        <div style="display:flex;gap:10px;justify-content:flex-end">
          <button id="save-settings" class="primary">Save Settings</button>
        </div>
      </div>
    </div>
  </div>

  <footer class="admin-footer"><a href="#" id="signout-link" class="signout-link">Sign out</a></footer>

  <script type="module">
    // ===== Firebase SDK via CDN =====
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js';
    import { getFirestore, collection, addDoc, deleteDoc, doc, setDoc, onSnapshot, serverTimestamp } from 'https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js';
    import { getAuth, signInWithEmailAndPassword, onAuthStateChanged, signOut } from 'https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js';

    // Your Firebase config
    const firebaseConfig = {
      apiKey: "AIzaSyCd-nbnWC-uvSjAkDujRu31fO-C-DkxT98",
      authDomain: "forty-sec-challenge.firebaseapp.com",
      projectId: "forty-sec-challenge",
      storageBucket: "forty-sec-challenge.firebasestorage.app",
      messagingSenderId: "655465733506",
      appId: "1:655465733506:web:c42b8864a60468bf84039b"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const auth = getAuth(app);

    // ===== Auth UI =====
    const loginPanel = document.getElementById('login-panel');
    const appPanel = document.getElementById('app');
    const authArea = document.getElementById('auth-area');
    const emailEl = document.getElementById('email');
    const passEl = document.getElementById('password');
    const loginBtn = document.getElementById('btn-login');
    const loginMsg = document.getElementById('login-msg');

    // ===== Theme toggle =====
    const THEME_KEY = 'leaderboardTheme';
    const btnTheme = document.getElementById('btn-theme');
    const themeLabel = document.querySelector('.theme-label');

    function applyTheme(theme){
      document.documentElement.setAttribute('data-theme', theme);
      if (themeLabel) themeLabel.textContent = theme === 'dark' ? 'Dark' : 'Light';
    }
    function getPreferredTheme(){
      const saved = localStorage.getItem(THEME_KEY);
      if (saved === 'light' || saved === 'dark') return saved;
      return window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light';
    }
    applyTheme(getPreferredTheme());
    if (btnTheme){
      btnTheme.addEventListener('click', ()=>{
        const cur = document.documentElement.getAttribute('data-theme') === 'light' ? 'light' : 'dark';
        const next = cur === 'dark' ? 'light' : 'dark';
        localStorage.setItem(THEME_KEY, next);
        applyTheme(next);
      });
    }
    if (window.matchMedia){
      const mql = window.matchMedia('(prefers-color-scheme: dark)');
      mql.addEventListener?.('change', (e)=>{
        const saved = localStorage.getItem(THEME_KEY);
        if (!saved) applyTheme(e.matches ? 'dark' : 'light');
      });
    }

    loginBtn.addEventListener('click', async ()=>{
      loginMsg.textContent = '';
      try{ await signInWithEmailAndPassword(auth, emailEl.value.trim(), passEl.value); }
      catch(err){ loginMsg.textContent = `Sign-in failed: ${err.code||err.message}`; }
    });

    onAuthStateChanged(auth, (user)=>{
      loginPanel.hidden = !!user;
      appPanel.hidden = !user;
    });

    // ===== Data & Settings =====
    const firstEl = document.getElementById('first');
    const lastEl  = document.getElementById('last');
    const timeEl  = document.getElementById('time');
    const addBtn = document.getElementById('add');
    const adminTbody = document.getElementById('admin-tbody');
    const clearFieldsBtn = document.getElementById('clear-fields');

    const settingTitle = document.getElementById('setting-title');
    const settingTopN = document.getElementById('setting-topN');
    const settingRotate = document.getElementById('setting-rotate');
    const saveSettingsBtn = document.getElementById('save-settings');

    // Settings modal
    const modal = document.getElementById('settings-modal');
    const btnSettings = document.getElementById('btn-settings');
    const btnCloseSettings = document.getElementById('btn-close-settings');

    const openModal = ()=>{ modal.setAttribute('open',''); modal.removeAttribute('aria-hidden'); };
    const closeModal = ()=>{ modal.removeAttribute('open'); modal.setAttribute('aria-hidden','true'); };

    btnSettings.addEventListener('click', openModal);
    btnCloseSettings.addEventListener('click', closeModal);
    modal.addEventListener('click', (e)=>{ if (e.target.hasAttribute('data-close')) closeModal(); });
    document.addEventListener('keydown', (e)=>{ if(e.key==='Escape') closeModal(); });

    // Draft autosave (first/last/time)
    const DRAFT_FIRST='leaderboardDraftFirst', DRAFT_LAST='leaderboardDraftLast', DRAFT_TIME='leaderboardDraftTime';
    function loadDraft(){ const a=localStorage.getItem(DRAFT_FIRST); if(a!==null) firstEl.value=a; const b=localStorage.getItem(DRAFT_LAST); if(b!==null) lastEl.value=b; const c=localStorage.getItem(DRAFT_TIME); if(c!==null) timeEl.value=c; }
    function saveDraft(){ localStorage.setItem(DRAFT_FIRST, firstEl.value); localStorage.setItem(DRAFT_LAST, lastEl.value); localStorage.setItem(DRAFT_TIME, timeEl.value); }
    [firstEl,lastEl,timeEl].forEach(el=> el.addEventListener('input', saveDraft));

    function parseTimeToMs(input){ if(typeof input==='number') return Math.round(input*1000); if(!input) return NaN; let s=(''+input).trim().replace(/,/g,'.'); if(!s) return NaN; if(s.includes(':')){ const [m,sec]=s.split(':'); const mm=Number(m), ss=Number(sec); if(Number.isNaN(mm)||Number.isNaN(ss)) return NaN; return Math.round((mm*60+ss)*1000);} const ss=Number(s); if(Number.isNaN(ss)) return NaN; return Math.round(ss*1000);} 
    function formatMs(ms){ if(!Number.isFinite(ms)) return '—'; const s=Math.floor(ms/1000); const m=Math.floor(s/60); const sec=s%60; const msPart=ms%1000; return `${m}:${sec.toString().padStart(2,'0')}.${msPart.toString().padStart(3,'0')}` }

    // Live entries table
    onSnapshot(collection(db, 'entries'), (snap)=>{
      const list = snap.docs.map(d=> ({ id:d.id, ...d.data() }));
      list.sort((a,b)=> (a.timeMs||Infinity)-(b.timeMs||Infinity) || (a.created?.seconds||0)-(b.created?.seconds||0));
      adminTbody.innerHTML='';
      list.forEach((e, idx)=>{
        const combined = [e.first||'', e.last||''].filter(Boolean).join(' ').trim();
        const displayName = combined || (e.name||''); // fallback for legacy records
        const label = `${escapeHtml(displayName)}${e.isChild?' ⭐':''}`;
        const tr=document.createElement('tr');
        tr.innerHTML=`<td class=\"rank\">${idx+1}</td><td>${label}</td><td class=\"time\">${formatMs(e.timeMs)}</td><td><button class=\"ghost btn-del\" data-id=\"${e.id}\">Delete</button></td>`;
        adminTbody.appendChild(tr);
      });
      adminTbody.querySelectorAll('.btn-del').forEach(btn=> btn.addEventListener('click', async (ev)=>{
        const id=ev.currentTarget.getAttribute('data-id');
        try{ await deleteDoc(doc(db,'entries',id)); await setDoc(doc(db,'meta','stats'), { lastUpdated: serverTimestamp() }, { merge:true }); }
        catch(err){ alert('Delete failed: '+(err.code||err.message)); }
      }));
    });

    // Settings load (one-time + live)
    onSnapshot(doc(db,'settings','display'), (snap)=>{
      const s = snap.exists()? snap.data(): { title:'Leaderboard', topN:'', rotateSeconds:0 };
      settingTitle.value = s.title || '';
      settingTopN.value = s.topN || '';
      settingRotate.value = s.rotateSeconds ?? 0;
    });

    // Add Entry (combined add + clear)
    addBtn.addEventListener('click', ()=>{ addEntry(true); });
    timeEl.addEventListener('keydown', (e)=>{ if(e.key==='Enter'){ addEntry(true); }});

    // Clear Fields
    clearFieldsBtn.addEventListener('click', ()=>{
      firstEl.value='';
      lastEl.value='';
      timeEl.value='';
      const adultRadio = document.querySelector('input[name="entrantType"][value="adult"]');
      if (adultRadio) adultRadio.checked = true;
      saveDraft();
      firstEl.focus();
    });

    async function addEntry(andClear=false){
      const first=firstEl.value.trim(); const last=lastEl.value.trim(); const raw=timeEl.value.trim();
      const selectedType = document.querySelector('input[name="entrantType"]:checked');
      const entrantType = selectedType ? selectedType.value : 'adult';
      const isChild = entrantType === 'child';

      if(!first){ alert('Please enter a first name.'); firstEl.focus(); return; }
      const timeMs=parseTimeToMs(raw); if(!Number.isFinite(timeMs) || timeMs<=0){ alert('Enter a valid time: mm:ss.mmm, ss.mmm, or seconds.'); timeEl.focus(); return; }
      try{
        await addDoc(collection(db,'entries'), { first, last, isChild, name: [first,last].filter(Boolean).join(' '), timeMs, created: serverTimestamp() });
        await setDoc(doc(db,'meta','stats'), { lastUpdated: serverTimestamp() }, { merge:true });
        if (andClear){ firstEl.value=''; lastEl.value=''; timeEl.value=''; saveDraft(); firstEl.focus(); }
      }catch(err){ alert('Add failed: '+(err.code||err.message)); }
    }

    function escapeHtml(s){ return (''+s).replace(/[&<>\"]/g, c=>({'&':'&amp;','<':'&lt;','>':'&gt;','\"':'&quot;'}[c])); }

    (function init(){ loadDraft(); })();
    window.addEventListener('DOMContentLoaded', ()=>{
      const link = document.getElementById('signout-link');
      if (link) link.addEventListener('click', (e)=>{ e.preventDefault(); signOut(auth); });
    });
  </script>
</body>
</html>
