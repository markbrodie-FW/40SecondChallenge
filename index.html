<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Leaderboard — Display (Cloud)</title>
  <style>
    :root{
      --bg:#0e0f12; --panel:#151822; --muted:#9aa3af; --text:#e5e7eb; --accent:#7dd3fc; --border:#1f2633;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,Noto Sans,sans-serif;background:var(--bg);color:var(--text);padding-bottom:56px;font-size:36px}
    .container{max-width:1100px;margin:0 auto;padding:20px}
    header{display:flex;align-items:center;justify-content:center;flex-direction:column;margin-bottom:16px}
    .big{font-size:clamp(26px,4vw,44px);font-weight:800;letter-spacing:.3px;text-align:center}
    .table-wrap{overflow:auto;border:1px solid var(--border);border-radius:16px}
    table{width:100%;border-collapse:separate;border-spacing:0}
    th,td{padding:12px 14px;border-bottom:1px solid var(--border)}
    th{position:sticky;top:0;background:#10131b;color:var(--muted);text-align:left;font-weight:600}
    tr:last-child td{border-bottom:none}
    .rank{font-variant-numeric:tabular-nums;font-weight:700}
    .time{font-variant-numeric:tabular-nums}
    .badge{display:inline-flex;align-items:center;gap:6px;border:1px solid var(--border);border-radius:999px;padding:6px 10px;color:var(--muted);font-size:12px}
    .fullscreen-btn{position:fixed;right:16px;bottom:70px;z-index:40}
    button{appearance:none;border:1px solid var(--border);background:#0b0d13;color:var(--text);padding:10px 14px;border-radius:10px;cursor:pointer}
    a{color:inherit;opacity:.8}
    .footer-status{position:fixed;left:0;right:0;bottom:0;z-index:30;display:flex;justify-content:center;gap:10px;padding:10px 14px;background:rgba(10,12,18,0.8);backdrop-filter:saturate(130%) blur(4px);border-top:1px solid var(--border)}

    /* Brand image at top */
    .brand-logo{ display:block; margin:0 auto 8px; height:auto; width:auto; max-height:clamp(48px, 12vmin, 400px); object-fit:contain; }
    @media (orientation: portrait){ .brand-logo{ max-height:clamp(64px, 14vmin, 160px); margin-bottom:12px; } }
  </style>
    <style>
  :root{
    --brand:#121FA2;   /* deep blue */
    --accent:#73BCFB;  /* light blue */
    --highlight:#FFF35F; /* yellow */
    --bg:#0b0f2b;
    --panel:#0f143f;
    --muted:#c9d6ff;
    --text:#ffffff;
    --border: rgba(255,255,255,0.08);
  }

  body{
    background:
      radial-gradient(1000px 500px at 15% 10%, rgba(18,31,162,0.25), transparent),
      radial-gradient(900px 500px at 85% 90%, rgba(255,243,95,0.12), transparent),
      var(--bg);
    color: var(--text);
  }
  th{ background: var(--brand) !important; color: #fff !important; }
  .table-wrap{ border-color: var(--border) !important; }
  .badge{
    color: var(--accent) !important;
    border-color: rgba(115,188,251,0.40) !important;
    background: rgba(115,188,251,0.06) !important;
  }
  a{ color: var(--accent) !important; opacity: 1 !important; }
</style>
<style>
  /* === Animated gradient using your colours === */
  :root{
    --grad1: #121FA2;  /* deep blue */
    --grad2: #0A1144;  /* light blue */
    --grad3: #1E4AF2;  /* yellow */
  }

  /* Keep the current UI readable; animate behind everything */
  body{ position: relative; }
  body::before{
    content: "";
    position: fixed;    /* cover the viewport even when scrolling */
    inset: 0;
    z-index: -1;        /* sit behind all content */
    background: linear-gradient(-45deg, var(--grad1), var(--grad2), var(--grad3), var(--grad2));
    background-size: 400% 400%;
    animation: nt-gradient 16s ease infinite;
    /* Slight tone-down so table/content remain crisp; tweak if you want it punchier */
    filter: saturate(115%) brightness(0.90);
  }

  @keyframes nt-gradient {
    0%   { background-position:   0% 50%; }
    50%  { background-position: 100% 50%; }
    100% { background-position:   0% 50%; }
  }

  /* Accessibility: respect reduced motion preferences */
  @media (prefers-reduced-motion: reduce){
    body::before{
      animation: none;
      background-position: 50% 50%;
    }
  }
</style>
</head>
<body>
  <div class="container">
    <header>
      <img src="https://markbrodie-fw.github.io/40SecondChallenge/40SecChallenge.png" alt="40 Second Challenge" class="brand-logo" />
      <div class="big" id="screen-title">Leaderboard</div>
    </header>

    <div class="table-wrap">
      <table aria-label="Leaderboard table">
        <thead>
          <tr>
            <th style="width:90px">Rank</th>
            <th>Name</th>
            <th style="width:160px">Time</th>
          </tr>
        </thead>
        <tbody id="display-tbody"></tbody>
      </table>
    </div>
  </div>

  <footer class="footer-status" aria-live="polite">
    <span class="badge" id="entry-count">0 entries</span>
    <span class="badge" id="last-updated">Updated —</span>
  </footer>

  <button class="fullscreen-btn" id="btn-fullscreen" title="Enter fullscreen">⤢ Fullscreen</button>

  <script type="module">
    // ===== Firebase (client SDK via CDN) =====
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js';
    import { getFirestore, collection, doc, onSnapshot, query, orderBy } from 'https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js';

    // Your Firebase config (kept from your file)
    const firebaseConfig = {
      apiKey: "AIzaSyCd-nbnWC-uvSjAkDujRu31fO-C-DkxT98",
      authDomain: "forty-sec-challenge.firebaseapp.com",
      projectId: "forty-sec-challenge",
      storageBucket: "forty-sec-challenge.firebasestorage.app",
      messagingSenderId: "655465733506",
      appId: "1:655465733506:web:c42b8864a60468bf84039b"
    };


    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    // ===== UI Elements =====
    const screenTitle = document.getElementById('screen-title');
    const entryCount  = document.getElementById('entry-count');
    const lastUpdated = document.getElementById('last-updated');
    const displayTbody= document.getElementById('display-tbody');

    // Live state
    let settings = { title:'Leaderboard', topN:'', rotateSeconds:0 };
    let entries = [];
    let rotateIndex=0, rotateTimer=null;

    // Listen to settings (doc: settings/display)
    onSnapshot(doc(db, 'settings', 'display'), (snap)=>{
      if (snap.exists()) settings = { ...settings, ...snap.data() };
      render();
    });

    // Listen to entries (collection: entries). Order by timeMs asc for speed
    onSnapshot(query(collection(db, 'entries'), orderBy('timeMs', 'asc')), (snap)=>{
      entries = snap.docs.map(d=> ({ id:d.id, ...d.data() }));
      render();
    });

    // Listen to meta/stats for lastUpdated timestamp
    onSnapshot(doc(db, 'meta', 'stats'), (snap)=>{
      if (snap.exists() && snap.data().lastUpdated){
        const ts = snap.data().lastUpdated.toDate();
        lastUpdated.textContent = `Updated ${ts.toLocaleString()}`;
      }
    });

    function formatDisplayName(e){
      // Prefer first/last from Firestore; fall back to parsing legacy e.name
      let first = (e.first||'').trim();
      let last  = (e.last||'').trim();
      if (!first && e.name){
        const parts = String(e.name).trim().split(/\s+/);
        first = parts[0]||''; last = parts.slice(1).join(' ');
      }
      const initial = last ? (last[0].toUpperCase()+'.') : '';
      const base = [first, initial].filter(Boolean).join(' ');
      const star = e.isChild ? ' ⭐' : '';
      return escapeHtml(base + star);
    }

    function render(){
      screenTitle.textContent = settings.title || 'Leaderboard';

      // Stable sort (tie-break by created if present)
      const list = entries.slice().sort((a,b)=> (a.timeMs||Infinity)-(b.timeMs||Infinity) || (a.created?.seconds||0)-(b.created?.seconds||0));
      const topN = settings.topN ? Math.max(1, Number(settings.topN)) : null;
      const view = topN ? list.slice(0, topN) : list;

      entryCount.textContent = `${list.length} entr${list.length===1?'y':'ies'}`;

      displayTbody.innerHTML = '';
      view.forEach((e, idx)=>{
        const tr=document.createElement('tr');
        tr.innerHTML = `<td class="rank">${idx+1}</td><td>${formatDisplayName(e)}</td><td class="time">${formatMs(e.timeMs)}</td>`;
        displayTbody.appendChild(tr);
      });

      // Row highlight rotation
      if (rotateTimer) clearInterval(rotateTimer);
      const secs = Number(settings.rotateSeconds)||0;
      if (secs>0 && view.length>0){
        const rows = [...displayTbody.querySelectorAll('tr')];
        const tick=()=>{ rows.forEach(r=> r.style.background=''); const r=rows[rotateIndex%rows.length]; r.style.background='rgba(125,211,252,0.08)'; rotateIndex++; };
        tick(); rotateTimer=setInterval(tick, secs*1000);
      }
    }

    // Helpers
    function formatMs(ms){ if(!Number.isFinite(ms)) return '—'; const s=Math.floor(ms/1000); const m=Math.floor(s/60); const sec=s%60; const msPart=ms%1000; return `${m}:${sec.toString().padStart(2,'0')}.${msPart.toString().padStart(3,'0')}` }
    function escapeHtml(s){ return (''+s).replace(/[&<>\"]/g, c=>({'&':'&amp;','<':'&lt;','>':'&gt;','\"':'&quot;'}[c])); }

    // Fullscreen
    document.getElementById('btn-fullscreen').addEventListener('click', ()=>{
      const el = document.documentElement; if (!document.fullscreenElement){ el.requestFullscreen?.(); } else { document.exitFullscreen?.(); }
    });
  </script>
</body>
</html>